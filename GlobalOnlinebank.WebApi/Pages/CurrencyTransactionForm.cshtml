@page
@using GlobalOnlinebank.Domain.Entities
@model CurrencyTransferModel
@{
ViewData["Title"] = "Валютный перевод";
}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f6f8; margin: 0; }
        .container { width: 100%; max-width: 1100px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .section-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .row { display: flex; gap: 20px; width: 100%; }
        .field { flex: 1; display: flex; flex-direction: column; margin-bottom: 15px; }
        .field label { font-size: 13px; margin-bottom: 4px; color: #555; }
        .field input, .field select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
        textarea { resize: vertical; min-height: 70px; }
        .btn-next { padding: 12px 25px; background: #00a046; border: none; border-radius: 8px; color: white; font-size: 15px; cursor: pointer; margin-top: 10px; }
        .error { color: red; font-size: 12px; }
        .validation-summary { margin-bottom: 10px; color: red; }
    </style>
</head>
<body>
<div class="container">
    <h1>@ViewData["Title"]</h1>

    <form onsubmit="submitTransfer(event)">
        <!-- Шаг 1 -->
        <div class="card">
            <div class="section-title">Отправитель</div>

            <div class="row">
                <div class="field">
                    <label>Счёт отправителя</label>
                    <select name="senderAccountNumber">
                        <option value="">-- Выберите счёт --</option>
                        @foreach (var acc in Model.Accounts)
                        {
                        <option value="@acc.AccountNumber">@acc.AccountNumber — @acc.Balance @acc.Currency</option>
                        }
                    </select>
                </div>

                <div class="field">
                    <label>Валюта</label>
                    <select name="currency" id="currency">
                        <option value="">-- Выберите валюту --</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Сумма</label>
                    <input name="amount" type="number" step="0.01" />
                </div>
            </div>
        </div>

        <!-- Шаг 2 -->
        <div class="card">
            <div class="section-title">Получатель</div>

            <div class="row">
                <div class="field">
                    <label>Имя получателя</label>
                    <input name="recipientName" />
                </div>
                <div class="field">
                    <label>Счёт получателя</label>
                    <input name="receiverAccountNumber" />
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Страна</label>
                    <input name="recipientCountry" />
                </div>
                <div class="field">
                    <label>Город</label>
                    <input name="recipientCity" />
                </div>
            </div>

            <div class="field">
                <label>Полный адрес</label>
                <input name="recipientAddress" />
            </div>
        </div>

        <!-- Шаг 3 -->
        <div class="card">
            <div class="section-title">Банк получателя</div>

            <div class="row">
                <div class="field">
                    <label>SWIFT</label>
                    <input name="recipientBankSwift" />
                </div>
                <div class="field">
                    <label>Название банка</label>
                    <input name="recipientBankName" />
                </div>
            </div>

            <div class="field">
                <label>Назначение платежа</label>
                <textarea name="paymentPurpose"></textarea>
            </div>

            <div class="row">
                <div class="field">
                    <label>Счёт списания комиссии</label>

                    <div style="font-size:12px;margin-bottom:5px;color:#666;">
                        @{
                        var bonus = Model.Accounts.FirstOrDefault(a => a.AccountType == AccountType.Bonus);
                        }
                        @if (bonus != null)
                        {
                        <input type="hidden" id="bonusAccountNumber" value="@bonus.AccountNumber" />
                        <span>Бонусный счёт: @bonus.AccountNumber — @bonus.Balance @bonus.Currency</span>
                        }
                    </div>

                    <select name="commissionPayerAccountNumber">
                        <option value="">-- Выберите счёт --</option>
                        @foreach (var acc in Model.Accounts)
                        {
                        <option value="@acc.AccountNumber">@acc.AccountNumber — @acc.Balance @acc.Currency</option>
                        }
                    </select>
                </div>
            </div>

            <div class="field">
                <label><input id="useBonus" type="checkbox" /> Списать бонусы</label>
            </div>

            <button type="submit" class="btn-next">Отправить</button>
        </div>
    </form>
</div>

<script>
    const accounts = @Json.Serialize(Model.Accounts);
    
    async function submitTransfer(e) {
        e.preventDefault();

        const data = {
            senderAccountNumber: document.querySelector("[name='senderAccountNumber']").value,
            receiverAccountNumber: document.querySelector("[name='receiverAccountNumber']").value,
            amount: parseFloat(document.querySelector("[name='amount']").value),
            currency: document.querySelector("[name='currency']").value,

            recipientName: document.querySelector("[name='recipientName']").value,
            recipientBankSwift: document.querySelector("[name='recipientBankSwift']").value,
            recipientBankName: document.querySelector("[name='recipientBankName']").value,
            recipientCountry: document.querySelector("[name='recipientCountry']").value,
            recipientCity: document.querySelector("[name='recipientCity']").value,
            recipientAddress: document.querySelector("[name='recipientAddress']").value,
            paymentPurpose: document.querySelector("[name='paymentPurpose']").value,

            commissionPayerAccountNumber: document.querySelector("[name='commissionPayerAccountNumber']").value,

            bonusAccountNumber: null,
            idempotencyKey: crypto.randomUUID()
        };

        if (document.getElementById("useBonus").checked) {
            const bonusAcc = accounts.find(a => a.accountType === 2);
            if (bonusAcc) {
                data.bonusAccountNumber = bonusAcc.accountNumber;
            }
        }

        const response = await fetch("https://localhost:7283/api/transaction", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const err = await response.text();
            alert("Ошибка: " + err);
            return;
        }

        const result = await response.json();
        alert("Транзакция создана! ID: " + result.transactionId);
    }
    // Автоподстановка валюты по выбранному счёту
    
    document.querySelector("[name='senderAccountNumber']").addEventListener("change", function() {
        const acc = accounts.find(a => a.accountNumber === this.value);
        const currencySelect = document.getElementById("currency");

        if (acc) {
            currencySelect.innerHTML = `<option value="${acc.currency}">${acc.currency}</option>`;
        } else {
            currencySelect.innerHTML = `<option value="">-- Выберите валюту --</option>`;
        }
    });

</script>

</body>
</html>
-